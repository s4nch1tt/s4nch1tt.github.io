<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SANCHIT-FLIX - Stream Movies & Web Series</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- VARIABLES --- */
        :root {
            --main-color: #e50914; 
            --main-color-rgb: 229, 9, 20;
            --bg-color: #000; --card-bg: #111; --surface-color: #1C1C1E;
            --text-color: #fff; --text-color-light: #aaa;
            
            /* Shiny Button Variables */
            --shiny-cta-bg: #040404;
            --shiny-cta-fg: #ffffff;
            --main-color-faded-bg: rgba(229, 9, 20, 0.2);
            --main-color-glow: rgba(229, 9, 20, 0.5);
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family:'Netflix Sans', 'Helvetica Neue', Arial, sans-serif; }
        
        /* --- STARS BACKGROUND --- */
        body { 
            background: transparent !important; 
            color: var(--text-color); 
            max-width: 480px; 
            margin: 0 auto; 
            overflow-x: hidden; 
            -webkit-font-smoothing: antialiased; 
            padding-bottom: 70px; 
            position: relative; 
            min-height: 100vh; 
        }

        #stars-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
        }

        .star {
            position: absolute;
            background: #fff;
            border-radius: 50%;
            opacity: 0;
            animation: twinkle var(--duration) ease-in-out infinite;
        }

        @keyframes twinkle {
            0% { opacity: 0.2; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.1); } 
            100% { opacity: 0.2; transform: scale(0.8); }
        }
        
        /* --- UTILS --- */
        .loading-screen { position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; background:var(--bg-color); z-index:2000; }
        .loading-logo { font-size:40px; font-weight:700; color:var(--main-color); margin-bottom:16px; animation:pulse 1.5s infinite; letter-spacing: -1px; }
        .loading-text { color:var(--text-color-light); font-size:16px; animation:fadeInOut 2s infinite; }
        @keyframes pulse {0%{transform:scale(1);opacity:.8}50%{transform:scale(1.08);opacity:1}100%{transform:scale(1);opacity:.8}}
        @keyframes fadeInOut {0%,100%{opacity:.5}50%{opacity:1}}

        /* --- HEADER --- */
        .header { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); padding: 14px; display: flex; gap: 12px; align-items: center; position: sticky; top: 0; z-index: 90; border-bottom: 1px solid rgba(255, 255, 255, 0.08); }
        .logo-container { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        .logo{ font-size:20px; font-weight:800; color:var(--main-color); letter-spacing:-1px; }
        .provider-name-display { font-size: 11px; font-weight: 600; color: #eee; background: rgba(255, 255, 255, 0.08); padding: 3px 8px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .header-actions { margin-left: auto; display: flex; align-items: center; gap: 16px; }
        .header-icon-btn { background: none; border: 0; color: var(--text-color-light); font-size: 18px; cursor: pointer; }
        .back-btn { background: none; border: 0; color: var(--text-color-light); font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 5px; }

        /* --- SIDE MENU --- */
        #side-menu-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out; }
        #side-menu-panel { position: fixed; top: 0; left: 0; bottom: 0; width: 80%; max-width: 280px; background: #1C1C1E; padding: 30px 16px 24px 16px; transform: translateX(-100%); transition: transform 0.3s ease-in-out; display: flex; flex-direction: column; }
        body.menu-open #side-menu-overlay { opacity: 1; pointer-events: all; }
        body.menu-open #side-menu-panel { transform: translateX(0); }
        .side-menu-header { margin-bottom: 16px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-left: 10px; padding-bottom: 16px; }
        .side-menu-header h2 { font-size: 24px; font-weight: 800; color: #fff; }
        .side-menu-header p { color: var(--text-color-light); font-size: 14px; margin-top: 4px; }
        .provider-list { overflow-y: auto; scrollbar-width: none; display: flex; flex-direction: column; gap: 4px; }
        .provider-list::-webkit-scrollbar { display: none; }
        .provider-menu-btn { display: flex; align-items: center; gap: 12px; width: 100%; padding: 12px 10px; background: transparent; border: none; border-radius: 10px; color: var(--text-color-light); text-align: left; font-size: 16px; font-weight: 500; cursor: pointer; transition: background-color 0.2s, color 0.2s; position: relative; }
        .provider-menu-btn i.icon { font-size: 20px; width: 24px; text-align: center; color: #888; transition: color 0.2s; }
        .provider-menu-btn:hover { background-color: rgba(255, 255, 255, 0.05); }
        .provider-menu-btn.active { background-color: rgba(255, 255, 255, 0.1); color: #fff; font-weight: 700; }
        .provider-menu-btn.active i.icon { color: var(--main-color); }
        .provider-menu-btn .check-mark { margin-left: auto; color: var(--main-color); font-size: 16px; }
        
        .provider-tag-list { 
            font-size: 9px; 
            background: rgba(229, 9, 20, 0.2); 
            color: var(--main-color); 
            padding: 2px 6px; 
            border-radius: 4px; 
            margin-left: auto; 
            font-weight: 700; 
            white-space: nowrap; 
            border: 1px solid rgba(229, 9, 20, 0.3);
        }

        /* --- SLIDER --- */
        .slider-container { width: 100%; height: 230px; overflow: hidden; margin-bottom: 20px; position: relative; background: var(--card-bg); }
        .slider { display: flex; height: 100%; transition: transform 0.5s ease-in-out; }
        .slide { min-width: 100%; height: 100%; position: relative; cursor: pointer; }
        .slide img { width: 100%; height: 100%; object-fit: cover; display: block; filter: brightness(0.8); }
        .slide-overlay { position: absolute; left: 0; right: 0; bottom: 0; height: 100%; padding: 18px; display: flex; flex-direction: column; justify-content: flex-end; background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.6) 50%, #000 100%); }
        .slide-title { font-size: 20px; font-weight: 800; margin-bottom: 12px; color: var(--text-color); }
        .slide-action-btn { display: inline-flex; align-items: center; gap: 8px; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.2); color: #fff; padding: 8px 16px; border-radius: 20px; text-decoration: none; font-weight: 600; font-size: 14px; align-self: flex-start; }
        .slider-indicators { position: absolute; right: 12px; bottom: 12px; display: flex; gap: 8px; z-index: 10; }
        .indicator { width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,0.4); cursor: pointer; }
        .indicator.active { background: var(--main-color); transform: scale(1.2); }

        /* --- CONTENT --- */
        .category-section{ margin-bottom:28px; }
        .category-header{ display:flex; justify-content:space-between; align-items:center; padding:0 12px 8px; }
        .category-title{ font-size:18px; font-weight:800; color:var(--text-color); position:relative; padding-left:14px; }
        .category-title::before{ content:''; position:absolute; left:0; top:50%; transform:translateY(-50%); width:6px; height:20px; background:var(--main-color); border-radius:3px; }
        .see-all-btn{ color:var(--main-color); font-size:13px; text-decoration:none; background:var(--main-color-faded-bg); padding:6px 8px; border-radius:6px; }
        .content-slider{ display:flex; overflow-x:auto; gap:12px; padding:6px 12px 10px; scrollbar-width:none; }
        .content-slider::-webkit-scrollbar{ display:none; }
        .grid-item { flex: 0 0 calc(33.33% - 10px); cursor:pointer; transition:transform .18s; }
        .grid-item:hover { transform: translateY(-6px); }
        .content-card { border-radius:8px; overflow:hidden; position:relative; background:var(--card-bg); width: 100%; aspect-ratio: 2/3; }
        .content-card img { width:100%; height:100%; object-fit:cover; display:block; transition: opacity 0.3s; }
        
        /* --- SHINY TEXT EFFECT FOR MOVIE TITLES --- */
        .content-caption { 
            font-size: 13px; 
            font-weight: 700;
            text-align: center; 
            margin-top: 8px; 
            height: 32px; 
            overflow: hidden; 
            color: rgba(255,255,255,0.6); 
            background: linear-gradient(
                110deg, 
                rgba(255,255,255,0.6) 40%, 
                #ffffff 50%, 
                rgba(255,255,255,0.6) 60% 
            );
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: textShimmer 3s linear infinite;
        }
        @keyframes textShimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        .category-grid { padding:12px; display:grid; grid-template-columns: repeat(3, 1fr); gap: 20px 12px; }
        .genres-grid { padding: 12px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .provider-badge { position: absolute; top: 6px; right: 6px; background: rgba(0,0,0,0.6); color: var(--main-color); font-size: 10px; font-weight: 800; padding: 3px 8px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(6px); text-transform: uppercase; }

        /* --- SEARCH UI --- */
        #search-page::before { content: ''; position: fixed; inset: 0; z-index: -1; background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .search-container { position: sticky; top: 0; z-index: 100; padding: 16px; display: flex; gap: 10px; align-items: center; }
        .search-input-wrapper { position: relative; flex-grow: 1; }
        .search-input { width: 100%; color: #fff; padding: 12px 40px 12px 16px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 25px; font-size: 16px; outline: none; transition: all 0.3s; }
        .search-input:focus { background: rgba(0,0,0,0.5); border-color: var(--main-color); box-shadow: 0 0 15px var(--main-color-glow); }
        .clear-btn { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); font-size: 14px; color: #888; background: rgba(255,255,255,0.1); border-radius: 50%; width: 22px; height: 22px; border: 0; cursor: pointer; display: none; align-items: center; justify-content: center; }
        #search-suggestions { position: absolute; top: 110%; left: 0; right: 0; background: #1a1a1a; border: 1px solid #333; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 201; display: none; }

        /* FIXED: SEARCH DESCRIPTION ALIGNMENT (CENTERED LIKE OLD CODE) */
        #search-description {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-color-light);
            animation: fadeSlideUp 0.6s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #search-description h3 { font-size: 22px; font-weight: 800; color: #fff; margin-bottom: 10px; text-align: center; width: 100%; }
        #search-description p { font-size: 14px; color: #888; text-align: center; width: 100%; max-width: 300px; margin: 0 auto; line-height: 1.5; }

        @keyframes fadeSlideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CATEGORIZED SEARCH LAYOUT --- */
        #search-grouped-container { padding-bottom: 40px; }
        .search-provider-section { margin-bottom: 30px; animation: fadeIn 0.5s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .search-provider-header {
            text-align: center; color: #ff3333; font-size: 16px; font-weight: 900;
            text-shadow: 0 0 10px rgba(229, 9, 20, 0.9), 0 0 20px rgba(229, 9, 20, 0.4);
            margin: 20px auto 15px; text-transform: uppercase; letter-spacing: 2px;
            position: relative; padding-bottom: 12px; width: fit-content;
            display: block;
        }

        .search-provider-header::after {
            content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 80px; height: 2.5px; background: #ffffff;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.8); border-radius: 2px;
        }

        .search-provider-scroll {
            display: flex;
            overflow-x: auto;
            gap: 14px;
            padding: 10px 14px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .search-provider-scroll::-webkit-scrollbar { display: none; }
        
        .search-item-fixed {
            flex: 0 0 120px;
            transition: transform 0.2s;
            cursor: pointer;
        }
        .search-item-fixed:hover { transform: scale(1.05); }

        /* --- DETAIL PAGE --- */
        .detail-page{ padding-top:60px; }
        .detail-backdrop{ width:100%; height:250px; position:relative; overflow:hidden; }
        .detail-backdrop img{ width:100%; height:100%; object-fit:cover; display:block; filter:brightness(.7); transition: opacity 0.5s; }
        .detail-backdrop::after{ content:''; position:absolute; left:0; right:0; bottom:0; height:120px; background:linear-gradient(to top, #000, transparent); }
        .detail-content{ padding:14px; display:flex; gap:12px; margin-top:-80px; position:relative; z-index:10; }
        .detail-poster{ width:120px; height:180px; border-radius:10px; overflow:hidden; border:3px solid var(--card-bg); box-shadow:0 10px 20px rgba(0,0,0,.5); margin-right:12px; flex-shrink:0; }
        .detail-poster img{ width:100%; height:100%; object-fit:cover; display:block; transition: opacity 0.5s; }
        .detail-info{ flex:1; }
        .detail-title{ font-size:20px; font-weight:800; margin-bottom:8px; line-height:1.1; color:var(--text-color); }
        .detail-meta{ display:flex; flex-wrap:wrap; gap:10px; color:#cfcfcf; font-size:13px; margin-bottom:12px; }
        
        .meta-rating { background: #f5c518; color: #000; font-weight: 800; padding: 2px 6px; border-radius: 4px; font-size: 12px; display: inline-flex; align-items: center; gap: 4px; }
        .meta-year { background: rgba(255,255,255,0.15); color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        .meta-genre { color: var(--main-color); font-weight: 600; }
        .detail-cast { margin-top: 12px; color: #aaa; font-size: 13px; line-height: 1.4; }
        .detail-cast strong { color: #fff; }

        .action-row { display: flex; gap: 12px; margin-bottom: 12px; }
        .action-btn { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: #fff; font-weight: 600; font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; }
        .action-btn.active { background: var(--main-color); border-color: var(--main-color); }
        #detail-storyline { background: #0A0A0A; border: 1px solid #222; padding: 14px; border-radius: 8px; margin: 14px 0 24px; color: #ddd; font-size: 15px; line-height: 1.6; text-align: justify; }
        #download-section-title { font-size:18px; margin-bottom:16px; color:var(--main-color); position:relative; padding-left:16px; transition: color 0.3s; }
        #download-section-title::before { content:''; position:absolute; left:0; top:50%; transform:translateY(-50%); width:6px; height:18px; background:var(--main-color); border-radius:3px; transition: background-color 0.3s; }
        .download-links-section { padding: 0 14px; margin-bottom: 24px; }
        .link-list { display: flex; flex-direction: column; gap: 12px; }

        /* --- SHINY BUTTON STYLES --- */
        .link-btn, .genre-btn {
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 16px 24px; 
            background: linear-gradient(to bottom, #1a1a1a, #000);
            background-image: url("https://cdn.prod.website-files.com/689597cc2d57ee623f5a24a2/689646711500e4fcb201a6ff_Container%20(1).svg");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border: none;
            border-radius: 9999px; 
            color: #fff;
            font-weight: 700;
            font-size: 15px;
            text-decoration: none;
            cursor: pointer;
            overflow: hidden;
            margin-bottom: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            will-change: transform, box-shadow;
            isolation: isolate;
        }

        .link-btn::before, .genre-btn::before, .shiny-icon-btn::before {
            content: "";
            position: absolute;
            inset: -2px; 
            z-index: -2;
            border-radius: inherit;
            background: linear-gradient(90deg, var(--main-color), #ffffff, var(--main-color), #000, var(--main-color));
            background-size: 400% 100%;
            animation: borderFlow 4s linear infinite;
        }

        .link-btn::after, .genre-btn::after, .shiny-icon-btn::after {
            content: "";
            position: absolute;
            inset: 1.5px; 
            background: #040404;
            background-image: url("https://cdn.prod.website-files.com/689597cc2d57ee623f5a24a2/689646711500e4fcb201a6ff_Container%20(1).svg");
            background-size: cover;
            border-radius: inherit;
            z-index: -1;
        }

        .shiny-icon-btn {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px; height: 40px;
            min-width: 40px;
            border-radius: 50%;
            background: #000; 
            border: none;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: transform 0.2s;
            flex-shrink: 0; 
            margin: 0;
            isolation: isolate;
        }

        @keyframes borderFlow { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }

        .link-btn:hover, .shiny-icon-btn:hover { transform: translateY(-2px); box-shadow: 0 0 20px var(--main-color-glow); }
        .link-btn:active, .shiny-icon-btn:active { transform: scale(0.96); }

        .link-btn span, .link-btn i, .shiny-icon-btn i { z-index: 2; position: relative; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }
        .link-btn i { color: var(--main-color); }
        .shiny-icon-btn i { color: #fff; }

        /* --- SETTINGS / ABOUT PAGE --- */
        .settings-header { padding: 16px 20px; font-size: 28px; font-weight: 700; }
        .settings-section-title { padding: 0 20px 10px; font-size: 14px; color: var(--text-color-light); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 10px; }
        .provider-slider { display: flex; overflow-x: auto; gap: 12px; padding: 0 20px 20px; scrollbar-width: none; }
        .provider-card { flex: 0 0 110px; width: 110px; background: var(--surface-color); border-radius: 12px; padding: 16px 10px; text-align: center; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; position: relative; }
        .provider-card.active { border-color: var(--main-color); background: rgba(229, 9, 20, 0.1); }
        .provider-card-icon { font-size: 24px; color: #fff; margin-bottom: 4px; }
        .provider-card-name { font-size: 12px; font-weight: 600; color: #ddd; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
        .provider-card-tag { font-size: 9px; color: var(--main-color); font-weight: 700; margin-top: 2px; }
        .settings-list { background: var(--surface-color); border-radius: 12px; margin: 0 20px 24px; overflow: hidden; }
        .settings-item { display: flex; align-items: center; padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; text-decoration: none; color: #fff; transition: background 0.2s; }
        .settings-item:hover { background: rgba(255,255,255,0.05); }
        .settings-icon { width: 30px; font-size: 18px; color: var(--main-color); display: flex; justify-content: center; align-items: center; margin-right: 12px; }
        .settings-text { flex: 1; font-size: 15px; font-weight: 500; }
        .settings-arrow { color: #555; font-size: 14px; margin-left: auto; }

        /* --- GLOW TEXT FOR CATEGORIZED TITLES --- */
        #detail-link-list .settings-section-title {
            color: #ff3333;
            font-size: 16px;
            font-weight: 900;
            text-shadow: 0 0 10px rgba(229, 9, 20, 0.9), 0 0 20px rgba(229, 9, 20, 0.6);
            padding: 10px 0;
            margin-top: 20px;
            letter-spacing: 1px;
        }

        .quality-subheader { 
            font-size: 11px; 
            font-weight: 900; 
            color: #ffffff; 
            margin: 12px 0 6px 6px; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
            display: inline-block; 
            padding-bottom: 2px; 
            text-shadow: 0 0 5px var(--main-color);
            border-bottom: 1.5 solid var(--main-color);
        }

        /* --- DROPDOWN STYLING --- */
        .category-select-wrapper { margin-bottom: 16px; }
        .styled-select {
            width: 100%;
            padding: 14px 16px;
            background: #111;
            border: 1.5px solid var(--main-color);
            border-radius: 12px;
            color: #fff;
            font-size: 15px;
            font-weight: 700;
            outline: none;
            cursor: pointer;
            box-shadow: 0 0 10px var(--main-color-faded-bg);
            transition: box-shadow 0.3s;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23e50914'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 20px;
        }

        /* --- PROVIDER MANAGER SPECIFIC --- */
        #pm-list { padding: 0 16px 20px; display: flex; flex-direction: column; gap: 10px; }
        .pm-item { display: flex; align-items: center; background: var(--surface-color); padding: 16px; border-radius: 12px; gap: 16px; cursor: pointer; transition: background 0.2s; }
        .pm-item:hover { background: #2a2a2a; }
        .pm-info { flex: 1; }
        .pm-name { font-size: 16px; font-weight: 600; margin-bottom: 4px; color: #fff; }
        .pm-details { font-size: 12px; color: #777; }
        .pm-status { width: 24px; height: 24px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; color: #555; font-size: 12px; }
        .pm-status.enabled { background: var(--main-color); color: #fff; }

        /* --- RESTORED TABS SIZING (LIKE OLD CODE) --- */
        .bottom-nav { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            max-width: 480px; 
            margin: 0 auto; 
            background: rgba(10,10,10,0.9); 
            backdrop-filter: blur(8px); 
            border-top: 1px solid rgba(255,255,255,0.05); 
            display: flex; 
            justify-content: space-around; 
            padding: 10px 0 12px; 
            z-index: 999; 
        }
        .nav-item { 
            flex: 1; 
            text-align: center; 
            color: #999; 
            text-decoration: none; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 6px; 
            font-size: 11px; 
            font-weight: 600;
            transition: color 0.2s;
        }
        .nav-item i { font-size: 20px; }
        .nav-item.active { color: var(--main-color); }
        
        #stream-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1500; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .stream-modal-content { background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid #222; width: 90%; max-width: 380px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,.5); }
        .modal-close-btn { position: absolute; right: 8px; top: 8px; background: none; border: none; color: #888; font-size: 20px; cursor: pointer; }
        .stream-list { display: flex; flex-direction: column; gap: 12px; max-height: 70vh; overflow-y: auto; }
        .stream-btn { display: block; width: 100%; padding: 14px; background: #222; border: 1px solid #333; color:var(--text-color); text-decoration: none; text-align: center; border-radius: 8px; font-weight: 700; transition: background .2s, border-color .2s; cursor: pointer; }

        /* WATCHLIST EMPTY STATE STYLE */
        .watchlist-empty { 
            text-align: center; 
            padding: 80px 20px; 
            color: var(--text-color-light); 
            grid-column: 1 / -1; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .watchlist-empty i { font-size: 48px; margin-bottom: 16px; color: #333; display: block; }
        .watchlist-empty p { font-size: 15px; font-weight: 600; color: #555; }

        /* PREFERENCES PREVIEW */
        .color-preview { width: 44px; height: 44px; border-radius: 12px; border: 2px solid #444; background: var(--main-color); transition: background-color 0.3s; margin-right: 12px; }
        .color-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; padding: 0 20px; }
        .color-option { aspect-ratio: 1; border-radius: 50%; cursor: pointer; border: 3px solid #1a1a1a; transition: transform 0.2s; }
        .color-option.active { border-color: #fff; transform: scale(1.1); box-shadow: 0 0 15px var(--main-color-glow); }
        .hex-input { flex: 1; background: #000; border: 1px solid #333; color: #fff; padding: 12px 16px; border-radius: 10px; font-size: 16px; font-family: monospace; outline: none; }
        .apply-btn { background: var(--main-color); color: #fff; border: none; padding: 14px; border-radius: 12px; font-weight: 700; font-size: 16px; text-align: center; width: 100%; cursor: pointer; transition: background-color 0.3s; margin-top: 12px; }
    </style>
</head>
<body>

  <div id="stars-container"></div>

  <div id="loading-screen" class="loading-screen">
    <div class="loading-logo">SANCHIT-FLIX</div>
    <div class="loading-text">Loading Entertainment...</div>
  </div>

  <div id="side-menu-overlay">
    <div id="side-menu-panel">
      <div class="side-menu-header">
        <h2>Select Provider</h2>
        <p>Content source</p>
      </div>
      <div id="provider-list" class="provider-list"></div>
    </div>
  </div>

  <!-- HOME PAGE -->
  <div id="home-page" class="page">
    <div class="header">
      <button id="menu-btn" class="header-icon-btn"><i class="fas fa-bars"></i></button>
      <div class="logo-container">
          <div class="logo">SANCHIT-FLIX</div>
          <span id="provider-name-display-home" class="provider-name-display"></span>
      </div>
      <div class="header-actions">
        <button id="theme-toggle-btn" class="header-icon-btn"><i class="fas fa-palette"></i></button>
        <button id="header-search-btn" class="header-icon-btn"><i class="fas fa-search"></i></button>
      </div>
    </div>
    <div id="slider-container" class="slider-container">
        <div id="slider" class="slider"></div>
        <div id="slider-indicators" class="slider-indicators"></div>
    </div>
    <div id="home-content"></div>
  </div>

  <div id="genres-page" class="page">
    <div class="header">
        <div class="logo">Genres</div>
        <span id="provider-name-display-genre" class="provider-name-display"></span>
    </div>
    <div id="genres-grid" class="genres-grid"></div>
  </div>

  <div id="watchlist-page" class="page">
    <div class="header">
        <div class="logo">My List</div>
    </div>
    <div id="watchlist-grid" class="category-grid"></div>
  </div>
  
  <!-- SEARCH PAGE -->
  <div id="search-page" class="page">
    <div class="search-container">
      <button id="search-back-btn" class="back-btn"><i class="fas fa-arrow-left"></i></button>
      <div class="search-input-wrapper">
          <input id="search-input" class="search-input" placeholder="Search..."/>
          <button id="clear-search-btn" class="clear-btn"><i class="fas fa-times"></i></button>
          <div id="search-suggestions"></div>
      </div>
    </div>
    <div id="search-description">
        <h3>Global Search</h3>
        <p>Search across multiple providers simultaneously.</p>
    </div>
    <div id="search-grouped-container"></div>
  </div>

  <!-- SETTINGS PAGE -->
  <div id="about-page" class="page">
      <div class="settings-header">Settings</div>
      <div class="settings-section-title">Content Provider</div>
      <div id="settings-provider-slider" class="provider-slider"></div>

      <div class="settings-section-title">Options</div>
      <div class="settings-list">
          <div class="settings-item" id="open-provider-manager">
              <div class="settings-icon"><i class="fas fa-puzzle-piece"></i></div>
              <div class="settings-text">Provider Manager</div>
              <i class="fas fa-chevron-right settings-arrow"></i>
          </div>
          <div class="settings-item" id="open-history-page">
              <div class="settings-icon"><i class="fas fa-history"></i></div>
              <div class="settings-text">Watch History</div>
              <i class="fas fa-chevron-right settings-arrow"></i>
          </div>
          <div class="settings-item" id="open-preferences-page">
              <div class="settings-icon"><i class="fas fa-palette"></i></div>
              <div class="settings-text">Preferences</div>
              <i class="fas fa-chevron-right settings-arrow"></i>
          </div>
      </div>

      <div class="settings-section-title">Data Management</div>
      <div class="settings-list">
          <div class="settings-item" onclick="if(confirm('Clear all app data?')) { localStorage.clear(); location.reload(); }">
              <div class="settings-icon" style="color: #e50914;"><i class="fas fa-trash-alt"></i></div>
              <div class="settings-text">Clear Cache</div>
              <i class="fas fa-chevron-right settings-arrow"></i>
          </div>
      </div>

      <div class="settings-section-title">Support</div>
      <div class="settings-list">
           <a href="https://t.me/S4NCHITT" target="_blank" class="settings-item">
               <div class="settings-icon" style="color: #229ED9;"><i class="fab fa-telegram"></i></div>
               <div class="settings-text">Join Telegram</div>
               <i class="fas fa-external-link-alt settings-arrow"></i>
           </a>
           <a href="https://instagram.com/sanch1t__" target="_blank" class="settings-item">
               <div class="settings-icon" style="color: #C13584;"><i class="fab fa-instagram"></i></div>
               <div class="settings-text">Follow Instagram</div>
               <i class="fas fa-external-link-alt settings-arrow"></i>
           </a>
      </div>
      
      <div style="text-align: center; color: #555; font-size: 12px; padding: 20px;">
          SANCHIT-FLIX v2.1.3<br>Developed by SANCHIT
      </div>
  </div>

  <!-- PROVIDER MANAGER PAGE -->
  <div id="provider-manager-page" class="page">
      <div class="header">
          <button class="back-btn"><i class="fas fa-arrow-left"></i></button>
          <div class="logo">Provider Manager</div>
      </div>
      <div id="pm-list"></div>
  </div>

  <!-- HISTORY PAGE -->
  <div id="history-page" class="page">
      <div class="header">
          <button class="back-btn"><i class="fas fa-arrow-left"></i></button>
          <div class="logo">Watch History</div>
      </div>
      <div id="history-grid" class="category-grid"></div>
  </div>

  <!-- PREFERENCES PAGE -->
  <div id="preferences-page" class="page">
      <div class="header">
          <button class="back-btn"><i class="fas fa-arrow-left"></i></button>
          <div class="logo">Preferences</div>
      </div>
      <div class="settings-section-title">Theme Presets</div>
      <div class="color-grid">
          <div class="color-option" style="background: #e50914;" onclick="setAppTheme('#e50914')"></div>
          <div class="color-option" style="background: #FFBF00;" onclick="setAppTheme('#FFBF00')"></div>
          <div class="color-option" style="background: #00FFFF;" onclick="setAppTheme('#00FFFF')"></div>
          <div class="color-option" style="background: #9D00FF;" onclick="setAppTheme('#9D00FF')"></div>
          <div class="color-option" style="background: #00FF00;" onclick="setAppTheme('#00FF00')"></div>
          <div class="color-option" style="background: #FF00FF;" onclick="setAppTheme('#FF00FF')"></div>
      </div>
      <div class="settings-section-title">Custom Hex</div>
      <div style="padding: 0 20px; display: flex; align-items: center; gap: 12px;">
          <div id="pref-preview" class="color-preview"></div>
          <input type="text" id="hex-input" class="hex-input" placeholder="#RRGGBB" oninput="updateThemePreview(this.value)">
      </div>
      <div style="padding: 0 20px;">
          <button class="apply-btn" onclick="applyCustomTheme()">Apply Color</button>
      </div>
  </div>
  
  <!-- DETAIL PAGE -->
  <div id="detail-page" class="page">
    <div class="header" style="background: transparent; border: none; padding: 14px;">
        <button id="detail-back-btn" class="shiny-icon-btn"><i class="fas fa-arrow-left"></i></button>
    </div>
    <div id="detail-backdrop" class="detail-backdrop"></div>
    <div class="detail-content">
      <div id="detail-poster" class="detail-poster"></div>
      <div class="detail-info">
        <h1 id="detail-title" class="detail-title content-caption"></h1>
        <div id="detail-meta" class="detail-meta"></div>
        <div class="action-row">
            <button id="watchlist-btn" class="action-btn"><i class="far fa-heart"></i> My List</button>
            <button id="share-btn" class="action-btn" onclick="shareContent()"><i class="fas fa-share-alt"></i> Share</button>
        </div>
      </div>
    </div>
    <div style="padding: 0 14px;">
      <div id="detail-storyline" class="detail-storyline"></div>
      <div class="download-links-section">
        <h3 id="download-section-title">Download Options</h3>
        <div id="detail-category-select-container" class="category-select-wrapper"></div>
        <div id="detail-link-list" class="link-list"></div>
      </div>
    </div>
  </div>
  
  <div id="stream-modal" class="stream-modal">
    <div class="stream-modal-content">
      <button class="modal-close-btn" onclick="closeStreamModal()"><i class="fas fa-times"></i></button>
      <h3 id="stream-modal-title">Select Option</h3>
      <div id="stream-list" class="stream-list"></div>
    </div>
  </div>

  <nav class="bottom-nav">
      <a href="#" id="nav-home" class="nav-item active"><i class="fas fa-home"></i><span>Home</span></a>
      <a href="#" id="nav-provider-search" class="nav-item"><i class="fas fa-search-location"></i><span>Search</span></a>
      <a href="#" id="nav-genres" class="nav-item"><i class="fas fa-th-large"></i><span>Genres</span></a>
      <a href="#" id="nav-watchlist" class="nav-item"><i class="fas fa-heart"></i><span>My List</span></a>
      <a href="#" id="nav-settings" class="nav-item"><i class="fas fa-cog"></i><span>Settings</span></a>
  </nav>

<script>
/* -------------- CONFIG & STATE -------------- */
const POLY_API_BASE = "https://poly-movies-ymnl.onrender.com";
const OMDB_API_KEY = '7755307f'; 
let activeProvider = null;
let catalogData = null;
let currentSlideIndex = 0;
let sliderInterval = null;
let previousPage = 'home-page';
let debounceTimer; 
let currentDetailItem = null;
let allManifestData = []; 
let searchMode = 'global';
let currentSearchId = 0;

const DISABLED_PROVIDERS = ["netflixMirror", "primeMirror", "moviesApi", "4khdhub", "mod", "uhd", "protonMovies", "cinemaLuxe", "movieBox", "skyMovieHD", "Joya9tv", "joya9tv","a111477","autoEmbed","cinemaluxe","dooflix","flixhq","guardahd","hianime","movies4u","moviesapi","multi","netflixmirror","ogomovies","primewire","primemirror","protonmovies","ridomovies","ringz","showbox","vadapav"];
const PROVIDER_HIGHLIGHTS = {'drive': 'Worldwide Movies', 'luxMovies': 'Indian Movies', 'animetsu': 'Best for Anime', 'hdhub4u': '4K Movies'};

/* -------------- DOM ELEMENTS -------------- */
const DOM = {
    body: document.body, 
    loadingScreen: document.getElementById('loading-screen'), 
    allPages: document.querySelectorAll('.page'), 
    backBtns: document.querySelectorAll('.back-btn'), 
    bottomNav: document.querySelector('.bottom-nav'),
    homePage: document.getElementById('home-page'), 
    homeContent: document.getElementById('home-content'), 
    genresPage: document.getElementById('genres-page'), 
    genresGrid: document.getElementById('genres-grid'),
    watchlistPage: document.getElementById('watchlist-page'), 
    watchlistGrid: document.getElementById('watchlist-grid'),
    aboutPage: document.getElementById('about-page'), 
    providerSlider: document.getElementById('settings-provider-slider'),
    searchPage: document.getElementById('search-page'), 
    searchInput: document.getElementById('search-input'), 
    clearSearchBtn: document.getElementById('clear-search-btn'), 
    searchGroupedContainer: document.getElementById('search-grouped-container'),
    detailPage: document.getElementById('detail-page'), 
    detailTitle: document.getElementById('detail-title'), 
    detailLinkList: document.getElementById('detail-link-list'),
    detailCategorySelectContainer: document.getElementById('detail-category-select-container'),
    watchlistBtn: document.getElementById('watchlist-btn'),
    slider: document.getElementById('slider'),
    sliderIndicators: document.getElementById('slider-indicators'),
    pmList: document.getElementById('pm-list'),
    historyGrid: document.getElementById('history-grid'),
    providerList: document.getElementById('provider-list')
};

/* -------------- LOGIC -------------- */
function createStars() {
    const container = document.getElementById('stars-container');
    if(!container) return;
    container.innerHTML = ''; 
    for(let i=0; i<100; i++){
        const star = document.createElement('div'); star.className = 'star';
        const x = Math.random() * 100, y = Math.random() * 100, size = Math.random() * 2 + 1;
        star.style.left = x + '%'; star.style.top = y + '%'; star.style.width = size + 'px'; star.style.height = size + 'px';
        star.style.setProperty('--duration', (Math.random() * 3 + 2) + 's'); star.style.animationDelay = (Math.random() * 5) + 's';
        container.appendChild(star);
    }
}
createStars();

const fetchJSON = async (url) => { try { const res = await fetch(url); if (!res.ok) throw new Error(`Fetch failed`); return res.json(); } catch (e) { return null; } };
const placeholder = (t) => `https://via.placeholder.com/500x750/111/ddd?text=${encodeURIComponent(t||'Content')}`;
const escapeHtml = (s) => String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const getShortTitle = (t) => t ? t.split(' ').slice(0, 4).join(' ') : '';
const getCleanTitle = (title) => title ? title.replace(/\s*\(.*?\)\s*|\s*\[.*?\]\s*/g, '').trim() : '';

/* --- THEME LOGIC --- */
function initTheme() { 
    const savedColor = localStorage.getItem('sanchitflix_color'); 
    if(savedColor) setAppTheme(savedColor); 
}
function setAppTheme(color) { 
    if(!/^#[0-9A-F]{6}$/i.test(color)) return; 
    document.documentElement.style.setProperty('--main-color', color); 
    localStorage.setItem('sanchitflix_color', color); 
    const preview = document.getElementById('pref-preview');
    if(preview) preview.style.backgroundColor = color;
}
function updateThemePreview(val) { 
    if(/^#[0-9A-F]{6}$/i.test(val)) {
        const preview = document.getElementById('pref-preview');
        if(preview) preview.style.backgroundColor = val; 
    }
}
function applyCustomTheme() { const val = document.getElementById('hex-input').value; setAppTheme(val); }

/* --- HISTORY LOGIC --- */
function addToHistory(item) {
    let hist = JSON.parse(localStorage.getItem('sanchitflix_history')) || [];
    hist = hist.filter(i => i.link !== item.link);
    hist.unshift(item);
    if(hist.length > 30) hist.pop();
    localStorage.setItem('sanchitflix_history', JSON.stringify(hist));
}
function renderHistory() {
    const hist = JSON.parse(localStorage.getItem('sanchitflix_history')) || [];
    DOM.historyGrid.innerHTML = hist.length ? '' : '<div class="watchlist-empty">No history found.</div>';
    hist.forEach(item => {
        const g = document.createElement('div'); g.className = 'grid-item';
        g.innerHTML = `<div class="content-card"><img src="${item.image || placeholder(item.title)}"/></div><p class="content-caption">${getShortTitle(item.title)}</p>`;
        g.onclick = () => openDetailPage(item, 'history-page', item.sourceProvider);
        DOM.historyGrid.appendChild(g);
    });
}

/* --- PROVIDER MANAGER LOGIC --- */
function loadProviderManager() {
    DOM.pmList.innerHTML = '';
    const hiddenProviders = JSON.parse(localStorage.getItem('sanchitflix_hidden_providers')) || [];
    allManifestData.forEach(p => {
        const isHidden = hiddenProviders.includes(p.value);
        const isDisabled = DISABLED_PROVIDERS.includes(p.value);
        const item = document.createElement('div');
        item.className = 'pm-item';
        item.innerHTML = `
            <div class="pm-info">
                <div class="pm-name">${p.display_name} ${isDisabled ? '<span style="font-size:10px; color:#ff3333;">(Offline)</span>' : ''}</div>
                <div class="pm-details">Version: ${p.version}</div>
            </div>
            <div class="pm-status ${!isHidden && !isDisabled ? 'enabled' : ''}">
                <i class="fas fa-${!isHidden && !isDisabled ? 'check' : 'times'}"></i>
            </div>
        `;
        item.onclick = () => {
            if (isDisabled) return;
            let currentHidden = JSON.parse(localStorage.getItem('sanchitflix_hidden_providers')) || [];
            if (currentHidden.includes(p.value)) {
                currentHidden = currentHidden.filter(id => id !== p.value);
            } else {
                currentHidden.push(p.value);
            }
            localStorage.setItem('sanchitflix_hidden_providers', JSON.stringify(currentHidden));
            loadProviderManager();
        };
        DOM.pmList.appendChild(item);
    });
}

/* --- SIDE MENU POPULATION --- */
function openProviderMenu() {
    if (!DOM.providerList) return;
    DOM.body.classList.add('menu-open'); 
    DOM.providerList.innerHTML = '';
    const hiddenProviders = JSON.parse(localStorage.getItem('sanchitflix_hidden_providers')) || [];
    const enabledProviders = allManifestData.filter(p => !DISABLED_PROVIDERS.includes(p.value) && !hiddenProviders.includes(p.value));
    
    enabledProviders.forEach(p => {
        const btn = document.createElement('button');
        btn.className = `provider-menu-btn ${p.value === activeProvider ? 'active' : ''}`;
        
        let iconClass = 'fas fa-film';
        if (p.type === 'global') iconClass = 'fas fa-globe';
        else if (p.type === 'india') iconClass = 'fas fa-flag';

        let checkMark = p.value === activeProvider ? '<i class="fas fa-check check-mark"></i>' : '';
        let tag = PROVIDER_HIGHLIGHTS[p.value] ? `<span class="provider-tag-list">${PROVIDER_HIGHLIGHTS[p.value]}</span>` : '';
        
        btn.innerHTML = `<i class="${iconClass} icon"></i> <span>${p.display_name}</span> ${tag} ${checkMark}`;
        btn.onclick = () => { 
            if (p.value !== activeProvider) {
                localStorage.setItem('sanchitflix_provider', p.value); 
                activeProvider = p.value; 
                closeProviderMenu(); 
                initializeApp(true); 
            } else {
                closeProviderMenu();
            }
        };
        DOM.providerList.appendChild(btn);
    });
}
function closeProviderMenu() { DOM.body.classList.remove('menu-open'); }

async function getEnhancedMetadata(rawTitle) {
    const cleanTitle = rawTitle.replace(/\s*\((\d{4})\).*$/, '').replace(/\[.*?\]/g, '').trim();
    try { const res = await fetch(`https://www.omdbapi.com/?apikey=${OMDB_API_KEY}&t=${encodeURIComponent(cleanTitle)}`); return await res.json(); } catch (e) { return null; }
}

const showPage = (pageId, fromPage = null) => {
    if (fromPage) previousPage = fromPage;
    document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
    const el = document.getElementById(pageId);
    if(el) el.style.display = 'block';
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    
    if (pageId === 'home-page') { document.getElementById('nav-home').classList.add('active'); startSliderAuto(); }
    else if (pageId === 'search-page') document.getElementById('nav-provider-search').classList.add('active');
    else if (pageId === 'genres-page') document.getElementById('nav-genres').classList.add('active');
    else if (pageId === 'watchlist-page') { document.getElementById('nav-watchlist').classList.add('active'); renderWatchlist(); }
    else if (pageId === 'about-page') { document.getElementById('nav-settings').classList.add('active'); loadSettingsPage(); }
    else if (pageId === 'history-page') renderHistory();
    else if (pageId === 'provider-manager-page') loadProviderManager();
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
};

document.addEventListener('DOMContentLoaded', () => { 
    initTheme(); 
    attachEventListeners(); 
    checkProviderSelection(); 
});

function attachEventListeners() {
    document.querySelectorAll('.back-btn').forEach(btn => btn.addEventListener('click', () => showPage(previousPage)));
    document.getElementById('detail-back-btn').addEventListener('click', () => showPage(previousPage));
    document.getElementById('menu-btn').addEventListener('click', openProviderMenu);
    document.getElementById('side-menu-overlay').addEventListener('click', closeProviderMenu);
    
    document.getElementById('nav-home').addEventListener('click', (e) => { e.preventDefault(); showPage('home-page'); });
    document.getElementById('nav-provider-search').addEventListener('click', (e) => { e.preventDefault(); searchMode = 'global'; showPage('search-page', 'home-page'); updateSearchUI(); });
    document.getElementById('nav-genres').addEventListener('click', (e) => { e.preventDefault(); showPage('genres-page'); });
    document.getElementById('nav-watchlist').addEventListener('click', (e) => { e.preventDefault(); showPage('watchlist-page'); });
    document.getElementById('nav-settings').addEventListener('click', (e) => { e.preventDefault(); showPage('about-page'); });
    
    document.getElementById('header-search-btn').addEventListener('click', () => { searchMode = 'provider'; showPage('search-page', 'home-page'); updateSearchUI(); });
    document.getElementById('watchlist-btn').addEventListener('click', toggleWatchlist);
    
    document.getElementById('open-provider-manager').addEventListener('click', () => showPage('provider-manager-page', 'about-page'));
    document.getElementById('open-history-page').addEventListener('click', () => showPage('history-page', 'about-page'));
    document.getElementById('open-preferences-page').addEventListener('click', () => showPage('preferences-page', 'about-page'));
    document.getElementById('theme-toggle-btn').addEventListener('click', () => showPage('preferences-page', 'home-page'));

    document.getElementById('search-input').addEventListener('input', (e) => {
        const query = e.target.value.trim();
        document.getElementById('clear-search-btn').style.display = query ? 'flex' : 'none';
        clearTimeout(debounceTimer);
        if (query.length > 2) debounceTimer = setTimeout(() => fetchSuggestions(query), 300);
    });
    document.getElementById('search-input').addEventListener('keydown', (e) => { 
        if(e.key === 'Enter') {
            const suggestions = document.getElementById('search-suggestions');
            if (suggestions) suggestions.style.display = 'none';
            doSearch(); 
        }
    });
}

function updateSearchUI() {
    const providerObj = allManifestData.find(p => p.value === activeProvider);
    const providerName = providerObj ? providerObj.display_name : activeProvider;
    const searchHeader = document.querySelector('#search-page h3');
    const searchDesc = document.querySelector('#search-page p');
    if (searchHeader) searchHeader.textContent = searchMode === 'global' ? "Global Search" : `Search in ${providerName}`;
    if (searchDesc) searchDesc.textContent = searchMode === 'global' ? "Search across multiple providers simultaneously." : `Search results limited to ${providerName}.`;
    const descBlock = document.getElementById('search-description');
    if (descBlock) descBlock.style.display = 'flex';
    DOM.searchGroupedContainer.innerHTML = '';
}

async function checkProviderSelection() {
    allManifestData = await fetchJSON(`${POLY_API_BASE}/manifest.json`) || [];
    activeProvider = localStorage.getItem('sanchitflix_provider');
    if (activeProvider) { initializeApp(false); } else {
        const firstEnabled = allManifestData.find(p => !DISABLED_PROVIDERS.includes(p.value));
        if(firstEnabled) { activeProvider = firstEnabled.value; localStorage.setItem('sanchitflix_provider', activeProvider); initializeApp(false); } 
    }
}

async function initializeApp(isSwitching) {
    if(!isSwitching) showPage('home-page');
    const providerObj = allManifestData.find(p => p.value === activeProvider);
    const homeName = document.getElementById('provider-name-display-home');
    const genreName = document.getElementById('provider-name-display-genre');
    if (homeName) homeName.textContent = providerObj?.display_name || activeProvider;
    if (genreName) genreName.textContent = providerObj?.display_name || activeProvider;
    DOM.bottomNav.style.display = 'flex'; DOM.loadingScreen.style.display = 'flex';
    catalogData = await fetchJSON(`${POLY_API_BASE}/api/${activeProvider}/catalog`);
    if (!catalogData) { DOM.loadingScreen.style.display = 'none'; return; }
    const trending = await fetchJSON(`${POLY_API_BASE}/api/${activeProvider}/posts?page=1`);
    if (trending) renderSlider(trending.slice(0, 3));
    buildHomePage(catalogData.catalog || []);
    buildGenresPage(catalogData.genres || []);
}

function buildGenresPage(genres) {
    DOM.genresGrid.innerHTML = '';
    if (!genres) return;
    genres.forEach(genre => {
        const btn = document.createElement('button'); btn.className = 'genre-btn';
        btn.innerHTML = `<span>${genre.title}</span>`;
        btn.onclick = () => { 
            const input = document.getElementById('search-input');
            if (input) input.value = genre.title;
            searchMode = 'provider';
            showPage('search-page', 'genres-page');
            doSearch();
        };
        DOM.genresGrid.appendChild(btn);
    });
}

function loadSettingsPage() {
    DOM.providerSlider.innerHTML = '';
    const hiddenProviders = JSON.parse(localStorage.getItem('sanchitflix_hidden_providers')) || [];
    allManifestData.filter(p => !DISABLED_PROVIDERS.includes(p.value) && !hiddenProviders.includes(p.value)).forEach(p => {
        const div = document.createElement('div');
        div.className = `provider-card ${p.value === activeProvider ? 'active' : ''}`;
        
        let iconClass = 'fas fa-film';
        if (p.type === 'global') iconClass = 'fas fa-globe';
        else if (p.type === 'india') iconClass = 'fas fa-flag';

        let tag = PROVIDER_HIGHLIGHTS[p.value] ? `<div class="provider-card-tag">${PROVIDER_HIGHLIGHTS[p.value]}</div>` : '';
        div.innerHTML = `<i class="${iconClass} provider-card-icon"></i><div class="provider-card-name">${p.display_name}</div>${tag}`;
        div.onclick = () => { activeProvider = p.value; localStorage.setItem('sanchitflix_provider', p.value); loadSettingsPage(); initializeApp(true); };
        DOM.providerSlider.appendChild(div);
    });
}

function renderSlider(items) {
    if (!DOM.slider || !DOM.sliderIndicators) return;
    DOM.slider.innerHTML = ''; DOM.sliderIndicators.innerHTML = '';
    items.forEach((item, index) => {
        const slide = document.createElement('div'); slide.className = 'slide';
        slide.innerHTML = `<img src="${item.image || placeholder(item.title)}"><div class="slide-overlay"><div class="slide-title">${escapeHtml(getCleanTitle(item.title))}</div><a class="slide-action-btn"><i class="fas fa-play"></i> Details</a></div>`;
        slide.onclick = () => openDetailPage(item, 'home-page');
        DOM.slider.appendChild(slide);
        const ind = document.createElement('div'); ind.className = 'indicator'; ind.onclick = () => goToSlide(index);
        DOM.sliderIndicators.appendChild(ind);
    });
    updateSliderTransform();
}
function updateSliderTransform() { if (DOM.slider) DOM.slider.style.transform = `translateX(-${currentSlideIndex * 100}%)`; if (DOM.sliderIndicators) Array.from(DOM.sliderIndicators.children).forEach((el, i) => el.classList.toggle('active', i === currentSlideIndex)); }
function goToSlide(index) { currentSlideIndex = index; updateSliderTransform(); }
function startSliderAuto() { clearInterval(sliderInterval); sliderInterval = setInterval(() => { if (DOM.slider && DOM.slider.children.length) { currentSlideIndex = (currentSlideIndex + 1) % DOM.slider.children.length; updateSliderTransform(); } }, 3000); }

function buildHomePage(catalog) {
    DOM.homeContent.innerHTML = '';
    if (!catalog) return;
    catalog.forEach(section => {
        const sectionEl = document.createElement('div'); sectionEl.className = 'category-section';
        sectionEl.innerHTML = `<div class="category-header"><h2 class="category-title">${section.title}</h2></div><div class="content-slider"></div>`;
        DOM.homeContent.appendChild(sectionEl);
        fetchJSON(`${POLY_API_BASE}/api/${activeProvider}/posts?filter=${encodeURIComponent(section.filter)}&page=1`).then(posts => {
            if(posts) {
                const slider = sectionEl.querySelector('.content-slider');
                posts.forEach(item => {
                    const g = document.createElement('div'); g.className = 'grid-item';
                    g.innerHTML = `<div class="content-card"><img src="${item.image || placeholder(item.title)}"/></div><p class="content-caption">${escapeHtml(getShortTitle(item.title))}</p>`;
                    g.onclick = () => openDetailPage(item, 'home-page');
                    slider.appendChild(g);
                });
            }
        });
    });
    DOM.loadingScreen.style.display = 'none';
}

async function doSearch() {
    const input = document.getElementById('search-input');
    const query = input ? input.value.trim() : '';
    if (!query) return;

    // HIDE SUGGESTIONS ON SEARCH
    const suggestions = document.getElementById('search-suggestions');
    if (suggestions) suggestions.style.display = 'none';

    currentSearchId++; const thisSearchId = currentSearchId;
    const desc = document.getElementById('search-description');
    if (desc) desc.style.display = 'none';
    DOM.searchGroupedContainer.innerHTML = 'Searching...';
    const hiddenProviders = JSON.parse(localStorage.getItem('sanchitflix_hidden_providers')) || [];
    const providers = searchMode === 'global' ? allManifestData.filter(p => !DISABLED_PROVIDERS.includes(p.value) && !hiddenProviders.includes(p.value)) : allManifestData.filter(p => p.value === activeProvider);
    const seenNames = new Set();
    providers.forEach(async (p) => {
        if (seenNames.has(p.display_name)) return; seenNames.add(p.display_name);
        const results = await fetchJSON(`${POLY_API_BASE}/api/${p.value}/search?query=${encodeURIComponent(query)}&page=1`);
        if (thisSearchId === currentSearchId && results && results.length > 0) {
            if (DOM.searchGroupedContainer.innerHTML === 'Searching...') DOM.searchGroupedContainer.innerHTML = '';
            renderCategorizedSearchResults(p.display_name, results, p.value);
        }
    });
}

function renderCategorizedSearchResults(name, items, id) {
    const section = document.createElement('div'); section.className = 'search-provider-section';
    const header = document.createElement('div'); header.className = 'search-provider-header'; header.textContent = name;
    const scroll = document.createElement('div'); scroll.className = 'search-provider-scroll';
    items.forEach(item => {
        const itemDiv = document.createElement('div'); itemDiv.className = 'search-item-fixed';
        itemDiv.innerHTML = `<div class="content-card"><img src="${item.image || placeholder(item.title)}"/></div><p class="content-caption">${getShortTitle(item.title)}</p>`;
        itemDiv.onclick = () => openDetailPage(item, 'search-page', id);
        scroll.appendChild(itemDiv);
    });
    section.appendChild(header); section.appendChild(scroll);
    DOM.searchGroupedContainer.appendChild(section);
}

async function openDetailPage(item, from, specProv = null) {
    const prov = specProv || activeProvider; currentDetailItem = { ...item, sourceProvider: prov };
    showPage('detail-page', from);
    addToHistory(currentDetailItem);
    const titleEl = document.getElementById('detail-title');
    const backdropEl = document.getElementById('detail-backdrop');
    const posterEl = document.getElementById('detail-poster');
    const storyEl = document.getElementById('detail-storyline');
    if(titleEl) titleEl.textContent = item.title;
    if(backdropEl) backdropEl.innerHTML = `<img src="${item.image || placeholder(item.title)}">`;
    if(posterEl) posterEl.innerHTML = `<img src="${item.image || placeholder(item.title)}">`;
    if(storyEl) storyEl.textContent = 'Loading details...';
    DOM.detailLinkList.innerHTML = ''; DOM.detailCategorySelectContainer.innerHTML = '';
    getEnhancedMetadata(item.title).then(d => { if(d && d.Plot && storyEl) storyEl.textContent = d.Plot; });
    updateWatchlistBtnState(currentDetailItem);
    const meta = await fetchJSON(`${POLY_API_BASE}/api/${prov}/meta?link=${encodeURIComponent(item.link)}`);
    if (meta && meta.linkList) {
        const seasons = {}, qualities = {}, uncategorized = [], qPriority = ['4K', '2160P', '1080P', '720P', '480P'];
        meta.linkList.forEach(l => {
            const qMatch = l.title.match(/(480p|720p|1080p|2160p|4k)/i); const q = qMatch ? qMatch[1].toUpperCase() : 'OTHER';
            if (meta.type === 'series') {
                const sMatch = l.title.match(/Season\s*(\d+)/i);
                if (sMatch) { const sKey = `Season ${sMatch[1]}`; if(!seasons[sKey]) seasons[sKey] = {}; if(!seasons[sKey][q]) seasons[sKey][q] = []; seasons[sKey][q].push(l); } else uncategorized.push(l);
            } else { if (q !== 'OTHER') { if(!qualities[q]) qualities[q] = []; qualities[q].push(l); } else uncategorized.push(l); }
        });
        const renderLink = (l, isSeries) => {
            const b = document.createElement('a'); b.className = 'link-btn'; b.target = '_blank';
            if(isSeries && l.episodesLink) { b.innerHTML = `<span>${l.title}</span><i class="fas fa-list"></i>`; b.onclick = (e) => { e.preventDefault(); getEpisodes(l.episodesLink, prov); }; }
            else { b.href = l.directLinks?.[0]?.link || l.link || '#'; b.innerHTML = `<span>${l.title}</span><i class="fas fa-download"></i>`; }
            DOM.detailLinkList.appendChild(b);
        };
        const buildDropdown = (type, keys) => {
            const select = document.createElement('select'); select.className = 'styled-select';
            keys.forEach(k => { const o = document.createElement('option'); o.value = k; o.textContent = k; select.appendChild(o); });
            select.onchange = (e) => {
                DOM.detailLinkList.innerHTML = '';
                if(type === 'series') {
                    const data = seasons[e.target.value];
                    [...qPriority, 'OTHER'].forEach(q => { if(data[q]) { const s = document.createElement('div'); s.className = 'quality-subheader'; s.textContent = q; DOM.detailLinkList.appendChild(s); data[q].forEach(l => renderLink(l, true)); }});
                } else qualities[e.target.value].forEach(l => renderLink(l, false));
            };
            return select;
        };
        if (meta.type === 'series' && Object.keys(seasons).length) {
            const k = Object.keys(seasons).sort((a,b) => a.localeCompare(b, undefined, {numeric: true}));
            DOM.detailCategorySelectContainer.appendChild(buildDropdown('series', k));
            DOM.detailCategorySelectContainer.querySelector('select').dispatchEvent(new Event('change'));
        } else if (meta.type !== 'series' && Object.keys(qualities).length) {
            const k = qPriority.filter(q => qualities[q]);
            DOM.detailCategorySelectContainer.appendChild(buildDropdown('movie', k));
            DOM.detailCategorySelectContainer.querySelector('select').dispatchEvent(new Event('change'));
        } else uncategorized.forEach(l => renderLink(l, meta.type === 'series'));
    }
}

async function getEpisodes(url, prov) {
    if(!url || url === "undefined") return;
    const modal = document.getElementById('stream-modal'), list = document.getElementById('stream-list');
    if(modal) modal.style.display = 'flex'; if(list) list.innerHTML = 'Loading...';
    const eps = await fetchJSON(`${POLY_API_BASE}/api/${prov}/episodes?url=${encodeURIComponent(url)}`);
    if(list) {
        list.innerHTML = '';
        eps?.forEach(e => { const b = document.createElement('a'); b.className = 'stream-btn'; b.href = e.link; b.target = '_blank'; b.textContent = e.title; list.appendChild(b); });
    }
}
function closeStreamModal() { const modal = document.getElementById('stream-modal'); if(modal) modal.style.display = 'none'; }

function updateWatchlistBtnState(item) {
    let list = JSON.parse(localStorage.getItem('sanchitflix_watchlist')) || [];
    const exists = list.some(i => i.link === item.link);
    const btn = document.getElementById('watchlist-btn');
    if (btn) { btn.classList.toggle('active', exists); btn.innerHTML = exists ? `<i class="fas fa-heart"></i> Saved` : `<i class="far fa-heart"></i> My List`; }
}
function toggleWatchlist() {
    let l = JSON.parse(localStorage.getItem('sanchitflix_watchlist')) || [];
    const idx = l.findIndex(i => i.link === currentDetailItem.link);
    if (idx > -1) l.splice(idx, 1); else l.push(currentDetailItem);
    localStorage.setItem('sanchitflix_watchlist', JSON.stringify(l));
    updateWatchlistBtnState(currentDetailItem);
}
function renderWatchlist() {
    const list = JSON.parse(localStorage.getItem('sanchitflix_watchlist')) || [];
    DOM.watchlistGrid.innerHTML = list.length ? '' : `<div class="watchlist-empty"><i class="far fa-folder-open"></i><p>Your list is empty.</p></div>`;
    list.forEach(item => {
        const gridItem = document.createElement('div'); gridItem.className = 'grid-item';
        gridItem.innerHTML = `<div class="content-card"><img src="${item.image || placeholder(item.title)}" onerror="this.src='${placeholder(item.title)}'"/></div><p class="content-caption">${escapeHtml(getShortTitle(item.title))}</p>`;
        gridItem.onclick = () => openDetailPage(item, 'watchlist-page', item.sourceProvider);
        DOM.watchlistGrid.appendChild(gridItem);
    });
}
async function fetchSuggestions(query) {
    const results = await fetchJSON(`${POLY_API_BASE}/api/${activeProvider || 'extraflix'}/search?query=${encodeURIComponent(query)}&page=1`);
    const s = document.getElementById('search-suggestions');
    if (results?.length) {
        s.innerHTML = ''; results.slice(0, 5).forEach(r => {
            const d = document.createElement('div'); d.style.padding = '12px'; d.style.borderBottom = '1px solid #222'; d.style.color = '#ccc'; d.textContent = getCleanTitle(r.title); d.onclick = () => { document.getElementById('search-input').value = d.textContent; s.style.display = 'none'; doSearch(); };
            s.appendChild(d);
        });
        s.style.display = 'block';
    } else s.style.display = 'none';
}
function shareContent() {
    if (!currentDetailItem) return;
    const shareData = { title: currentDetailItem.title, text: `Watch ${currentDetailItem.title} on SANCHIT-FLIX`, url: window.location.href };
    if (navigator.share) navigator.share(shareData).catch(() => {});
    else {
        const shareUrl = window.location.href;
        const tempInp = document.createElement('input');
        document.body.appendChild(tempInp);
        tempInp.value = shareUrl;
        tempInp.select();
        document.execCommand('copy');
        document.body.removeChild(tempInp);
        const btn = document.getElementById('share-btn');
        const old = btn.innerHTML; btn.innerHTML = '<i class="fas fa-check"></i> Copied';
        setTimeout(() => btn.innerHTML = old, 2000);
    }
}
</script>
</body>
</html>
